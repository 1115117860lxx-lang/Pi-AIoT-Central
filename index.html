<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AIoT 智能中控系统</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        /* --- 赛博朋克风格样式 --- */
        body { margin: 0; padding: 0; background-color: #0d1117; color: #c9d1d9; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; justify-content: center; align-items: center; }
        .container { width: 900px; height: 600px; background: #161b22; border-radius: 12px; box-shadow: 0 0 20px rgba(0, 255, 170, 0.1); display: flex; overflow: hidden; border: 1px solid #30363d; }
        
        /* 左侧：仪表盘 */
        .dashboard { width: 300px; background: #010409; padding: 20px; border-right: 1px solid #30363d; display: flex; flex-direction: column; gap: 20px; }
        .card { background: #161b22; padding: 15px; border-radius: 8px; border: 1px solid #30363d; }
        .card h3 { margin: 0 0 10px 0; font-size: 14px; color: #8b949e; }
        .status-value { font-size: 24px; font-weight: bold; color: #58a6ff; }
        .status-dot { width: 10px; height: 10px; background: #238636; border-radius: 50%; display: inline-block; margin-right: 5px; }
        
        /* 右侧：聊天区 */
        .chat-area { flex: 1; display: flex; flex-direction: column; background-image: radial-gradient(#21262d 1px, transparent 1px); background-size: 20px 20px; }
        .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        
        .msg { max-width: 70%; padding: 10px 15px; border-radius: 10px; line-height: 1.5; font-size: 14px; }
        .msg.user { align-self: flex-end; background: #1f6feb; color: white; border-bottom-right-radius: 2px; }
        .msg.ai { align-self: flex-start; background: #21262d; border: 1px solid #30363d; border-bottom-left-radius: 2px; }
        .msg.system { align-self: center; background: rgba(35, 134, 54, 0.2); color: #7ee787; font-size: 12px; border: 1px solid #238636; }

        /* 输入框 */
        .input-box { padding: 20px; background: #161b22; border-top: 1px solid #30363d; display: flex; gap: 10px; }
        input { flex: 1; background: #0d1117; border: 1px solid #30363d; color: white; padding: 12px; border-radius: 6px; outline: none; }
        input:focus { border-color: #58a6ff; }
        button { background: #238636; color: white; border: none; padding: 0 20px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { background: #2ea043; }
        button:disabled { background: #30363d; cursor: not-allowed; }
    </style>
</head>
<body>

<div id="app">
    <div class="container">
        <div class="dashboard">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="color: white;"><i class="ri-cpu-line"></i> AIoT HUB</h2>
                <div style="font-size: 12px; color: #238636;"><span class="status-dot"></span>System Online</div>
            </div>

            <div class="card">
                <h3><i class="ri-lightbulb-line"></i> 客厅主灯</h3>
                <div class="status-value" :style="{color: deviceStatus.light ? '#e3b341' : '#8b949e'}">
                    {{ deviceStatus.light ? 'ON' : 'OFF' }}
                </div>
            </div>

            <div class="card">
                <h3><i class="ri-windy-line"></i> 风扇状态</h3>
                <div class="status-value" :style="{color: deviceStatus.fan ? '#58a6ff' : '#8b949e'}">
                    {{ deviceStatus.fan ? 'Running' : 'Stopped' }}
                </div>
            </div>
            
            <div class="card">
                <h3><i class="ri-temp-hot-line"></i> 传感器数据 (模拟)</h3>
                <div class="status-value" style="font-size: 18px; color: #ff7b72;">
                    26.5°C / 45%
                </div>
            </div>
        </div>

        <div class="chat-area">
            <div class="messages" id="msgBox">
                <div class="msg ai">
                    你好，我是你的 AIoT 智能管家。请告诉我你需要操作什么设备？<br>
                    <i>(试着说：把灯打开，或者把风扇关掉)</i>
                </div>
                
                <div v-for="(item, index) in history" :key="index" :class="['msg', item.role]">
                    <span v-html="item.text"></span>
                </div>
                
                <div v-if="loading" class="msg ai">
                    <i class="ri-loader-4-line"></i> 正在思考并下达指令...
                </div>
            </div>

            <div class="input-box">
                <input type="text" v-model="inputText" @keyup.enter="sendMessage" placeholder="输入指令，例如：屋里太暗了..." :disabled="loading">
                <button @click="sendMessage" :disabled="loading">发送指令</button>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, reactive, nextTick } = Vue;

    createApp({
        setup() {
            const inputText = ref("");
            const loading = ref(false);
            const history = ref([]);
            
            // 模拟设备状态（前端显示用）
            const deviceStatus = reactive({
                light: false,
                fan: false
            });

            const sendMessage = async () => {
                if (!inputText.value.trim() || loading.value) return;

                // 1. 显示用户消息
                const userCmd = inputText.value;
                history.value.push({ role: 'user', text: userCmd });
                inputText.value = "";
                scrollToBottom();

                loading.value = true;

                try {
                    // 2. 请求你的 Python 后端
                    // 注意：这里的地址 localhost:8000 运行的地址
                    const res = await fetch("http://localhost:8000/api/control", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ command: userCmd })
                    });
                    
                    const data = await res.json();

                    if (data.status === 'success') {
                        // 3. 显示 AI 回复
                        history.value.push({ role: 'ai', text: data.message });
                        
                        // 4. 显示系统指令（装酷用）
                        const actionLog = `[SYSTEM] 识别设备: <b>${data.parsed_action.device}</b> | 动作: <b>${data.parsed_action.action}</b>`;
                        history.value.push({ role: 'system', text: actionLog });

                        // 5. 更新前端的模拟状态仪表盘
                        if (data.parsed_action.device === 'light') {
                            deviceStatus.light = (data.parsed_action.action === 'on');
                        }
                        if (data.parsed_action.device === 'fan') {
                            deviceStatus.fan = (data.parsed_action.action === 'on');
                        }

                    } else {
                        history.value.push({ role: 'ai', text: "❌ 抱歉，我没听懂。" });
                    }

                } catch (e) {
                    history.value.push({ role: 'system', text: "❌ 连接服务器失败，请检查 main.py 是否在运行！" });
                    console.error(e);
                } finally {
                    loading.value = false;
                    scrollToBottom();
                }
            };

            const scrollToBottom = () => {
                nextTick(() => {
                    const el = document.getElementById('msgBox');
                    el.scrollTop = el.scrollHeight;
                });
            };

            return { inputText, loading, history, sendMessage, deviceStatus };
        }
    }).mount('#app');
</script>

</body>
</html>